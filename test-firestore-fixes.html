<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firestore Fixes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .error-button {
            background: #ef4444;
        }
        .error-button:hover {
            background: #dc2626;
        }
        .log-area {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            color: #10b981;
        }
        .error {
            color: #ef4444;
        }
        .warning {
            color: #f59e0b;
        }
    </style>
</head>
<body>
    <h1>Firestore Error Handling Test</h1>
    
    <div class="test-section">
        <h2>Test Error Notifications</h2>
        <button class="test-button" onclick="testSaveNotification()">Test Save Notification</button>
        <button class="error-button" onclick="testErrorNotification()">Test Error Notification</button>
        <button class="error-button" onclick="testAuthError()">Test Auth Error</button>
        <button class="error-button" onclick="testNetworkError()">Test Network Error</button>
        <button class="error-button" onclick="testDataSizeError()">Test Data Size Error</button>
    </div>
    
    <div class="test-section">
        <h2>Test Bookmark Data Validation</h2>
        <button class="test-button" onclick="testValidBookmark()">Test Valid Bookmark</button>
        <button class="error-button" onclick="testInvalidBookmark()">Test Invalid Bookmark</button>
        <button class="error-button" onclick="testLargeBookmark()">Test Large Bookmark</button>
        <button class="test-button" onclick="testBookmarkCleanup()">Test Bookmark Cleanup</button>
    </div>
    
    <div class="test-section">
        <h2>Test Board Size Validation</h2>
        <button class="test-button" onclick="testSmallBoard()">Test Small Board</button>
        <button class="error-button" onclick="testLargeBoard()">Test Large Board</button>
    </div>
    
    <div class="log-area" id="logArea"></div>
    
    <script type="module">
        // Import the modules we need to test
        import { dbService, authService } from './firebase/firebase-config.js';
        import { syncService } from './firebase/sync-service.js';
        
        // Mock Debug object for testing
        window.Debug = {
            sync: {
                start: () => log('Sync: Starting...', 'info'),
                step: (msg) => log(`Sync: ${msg}`, 'info'),
                stepError: (msg, data) => log(`Sync Error: ${msg}`, 'error', data),
                done: (msg) => log(`Sync: ${msg}`, 'success'),
                detail: (msg, data) => log(`Sync Detail: ${msg}`, 'info', data)
            },
            firebase: {
                step: (msg) => log(`Firebase: ${msg}`, 'info'),
                stepError: (msg, data) => log(`Firebase Error: ${msg}`, 'error', data),
                detail: (msg, data) => log(`Firebase Detail: ${msg}`, 'info', data)
            }
        };
        
        // Mock AppState for testing
        window.AppState = {
            get: (key) => {
                if (key === 'boards') {
                    return [{
                        id: 0,
                        name: 'Test Board',
                        categories: [{
                            title: 'Test Category',
                            cards: [{
                                title: 'Test Card',
                                content: {},
                                bookmarks: []
                            }]
                        }],
                        canvasHeaders: [],
                        drawingPaths: []
                    }];
                }
                if (key === 'currentBoardId') return 0;
                return null;
            },
            set: (key, value) => {
                log(`AppState.set: ${key} = ${JSON.stringify(value)}`, 'info');
            }
        };
        
        // Logging function
        function log(message, type = 'info', data = null) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            
            let logText = `[${timestamp}] ${message}`;
            if (data) {
                logText += ` - ${JSON.stringify(data)}`;
            }
            
            logEntry.textContent = logText;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // Test functions
        window.testSaveNotification = function() {
            if (window.simpleNotifications) {
                window.simpleNotifications.showSaveNotification('saved');
                log('Save notification test completed', 'success');
            } else {
                log('Simple notifications not available', 'error');
            }
        };
        
        window.testErrorNotification = function() {
            if (window.simpleNotifications) {
                window.simpleNotifications.showError('Test error message');
                log('Error notification test completed', 'success');
            } else {
                log('Simple notifications not available', 'error');
            }
        };
        
        window.testAuthError = function() {
            if (window.simpleNotifications) {
                window.simpleNotifications.showError('Authentication error - please sign in again');
                log('Auth error notification test completed', 'success');
            }
        };
        
        window.testNetworkError = function() {
            if (window.simpleNotifications) {
                window.simpleNotifications.showError('Network error - please check your connection');
                log('Network error notification test completed', 'success');
            }
        };
        
        window.testDataSizeError = function() {
            if (window.simpleNotifications) {
                window.simpleNotifications.showError('Data validation error - some content may be too large');
                log('Data size error notification test completed', 'success');
            }
        };
        
        window.testValidBookmark = function() {
            const validBookmark = {
                title: 'Test Bookmark',
                url: 'https://example.com',
                description: 'A valid bookmark'
            };
            
            const result = syncService.validateBookmarkData(validBookmark);
            log(`Valid bookmark test: ${result ? 'PASSED' : 'FAILED'}`, result ? 'success' : 'error');
        };
        
        window.testInvalidBookmark = function() {
            const invalidBookmark = {
                title: 'Invalid Bookmark',
                // Missing URL
                description: 'An invalid bookmark'
            };
            
            const result = syncService.validateBookmarkData(invalidBookmark);
            log(`Invalid bookmark test: ${result ? 'FAILED (should be invalid)' : 'PASSED (correctly identified as invalid)'}`, !result ? 'success' : 'error');
        };
        
        window.testLargeBookmark = function() {
            const largeBookmark = {
                title: 'Large Bookmark',
                url: 'https://example.com',
                screenshot: 'x'.repeat(2000000) // 2MB of data
            };
            
            const result = syncService.validateBookmarkData(largeBookmark);
            log(`Large bookmark test: ${result ? 'FAILED (should be invalid)' : 'PASSED (correctly identified as invalid)'}`, !result ? 'success' : 'error');
        };
        
        window.testBookmarkCleanup = function() {
            const board = {
                categories: [{
                    title: 'Test Category',
                    cards: [{
                        title: 'Test Card',
                        bookmarks: [
                            {
                                title: 'Valid Bookmark',
                                url: 'https://example.com',
                                screenshot: 'x'.repeat(600000) // Too large
                            },
                            {
                                title: 'Invalid Bookmark',
                                // Missing URL
                                description: 'Should be removed'
                            },
                            {
                                title: 'Another Valid Bookmark',
                                url: 'https://example.org',
                                description: 'Should be kept'
                            }
                        ]
                    }]
                }]
            };
            
            const cleanedBoard = syncService.cleanBookmarkData(board);
            const bookmarkCount = cleanedBoard.categories[0].cards[0].bookmarks.length;
            log(`Bookmark cleanup test: ${bookmarkCount} bookmarks remaining (should be 2)`, bookmarkCount === 2 ? 'success' : 'error');
        };
        
        window.testSmallBoard = function() {
            const smallBoard = {
                id: 0,
                name: 'Small Board',
                categories: [{
                    title: 'Test Category',
                    cards: [{
                        title: 'Test Card',
                        bookmarks: [{
                            title: 'Test Bookmark',
                            url: 'https://example.com'
                        }]
                    }]
                }]
            };
            
            const result = syncService.isBoardDataTooLarge(smallBoard);
            log(`Small board test: ${result ? 'FAILED (should not be too large)' : 'PASSED (correctly identified as not too large)'}`, !result ? 'success' : 'error');
        };
        
        window.testLargeBoard = function() {
            const largeBoard = {
                id: 0,
                name: 'Large Board',
                categories: [{
                    title: 'Test Category',
                    cards: [{
                        title: 'Test Card',
                        bookmarks: [{
                            title: 'Large Bookmark',
                            url: 'https://example.com',
                            screenshot: 'x'.repeat(1000000) // 1MB of data
                        }]
                    }]
                }]
            };
            
            const result = syncService.isBoardDataTooLarge(largeBoard);
            log(`Large board test: ${result ? 'PASSED (correctly identified as too large)' : 'FAILED (should be too large)'}`, result ? 'success' : 'error');
        };
        
        // Initialize test environment
        log('Test environment initialized', 'success');
        log('Modules loaded:', 'info', { 
            dbService: !!dbService, 
            authService: !!authService, 
            syncService: !!syncService 
        });
    </script>
</body>
</html>